name: Build Companion Firmwares

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Wybierz platformy (szybkie budowanie)'
        required: true
        default: 'promicro'
        type: choice
        options:
          - promicro
          - heltecv4companionradiousb
          - RAK4631companionradiousb
          - TinyRelaycompanionradiousb
  push:
    tags:
      - 'companion-*'

jobs:

  build:
    runs-on: ubuntu-latest
    steps:

      - name: Clone Repo
        uses: actions/checkout@v4

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-environment

      - name: Build Firmwares
        env:
          FIRMWARE_VERSION: ${{ env.GIT_TAG_VERSION }}
          SELECTED_PLATFORM: ${{ github.event.inputs.platforms || 'ProMicro_companion_radio_usb' }}
        run: |
          echo "Building platform: $SELECTED_PLATFORM"
          /usr/bin/env bash build.sh build-companion-firmwares "$SELECTED_PLATFORM"




      - name: Copy Firmwares to Output
        run: |
          mkdir -p out
          echo "=== Znajduję wszystkie firmware'y ==="
          find .pio/build -name "firmware.*" -type f
          echo "=== Kopiuję do out/ ==="
          cp .pio/build/*/firmware.elf out/ 2>/dev/null || true
          cp .pio/build/*/firmware.bin out/ 2>/dev/null || true
          cp .pio/build/*/firmware.hex out/ 2>/dev/null || true
          cp .pio/build/*/firmware.zip out/ 2>/dev/null || true
          cp .pio/build/*/firmware.uf2 out/ 2>/dev/null || true
          echo "=== Zawartość out/ ==="
          ls -la out/
          echo "=== Pliki w out/ ==="
          find out/ -type f

      - name: Upload Workflow Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: companion-firmwares
          path: out



      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Companion Firmware ${{ env.GIT_TAG_VERSION }}
          body: ""
          draft: true
          files: out/*
